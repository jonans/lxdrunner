---

name: CI

# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
  pull_request:
    branches: [master]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    runs-on: self-hosted
    # runs-on: ubuntu-20.04
    
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: Setup base environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3-pip python3-venv python3-wheel

      - name: Setup virtualenv
        run: python3 -m venv venv

      - name: Development Install
        run: |
          . ./venv/bin/activate
          make upgrade-pip install-dev

      - name: Run pytest
        run: |
          . ./venv/bin/activate
          make tests

      - name: Build Packages
        run: |
          . ./venv/bin/activate
          make packages
          WHEEL=$(basename dist/*.whl)
          echo "WHEEL=$WHEEL" >> $GITHUB_ENV

      - name: Setup LXD
        run: |
          sudo ./scripts/setup-lxd.sh

      - name: Build LXD Alpine image
        run: ./scripts/build-alpine-image.sh

      - name: Export LXD Image:
        run: |
          lxc stop lxdrunner-build
          lxc publish lxdrunner-build --alias lxdrunner
          lxc image export lxdrunner lxdrunner-alpine.img

      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: true
          title: "Development Build"
          files: |
            lxdrunner-alpine.img.tar.gz
            dist/${{ env.WHEEL }}
