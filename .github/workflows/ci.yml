---

name: CI

# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
  pull_request:
    branches: [master]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      remote_debug:
        required: false
        default: false

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    runs-on:
      - self-hosted
      - vm
    # runs-on: ubuntu-20.04
    
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Setup base environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3-pip python3-venv python3-wheel

      - name: Setup virtualenv
        run: python3 -m venv venv

      - name: Development Install
        run: |
          . ./venv/bin/activate
          make upgrade-pip install-dev

      - name: Run pytest
        run: |
          . ./venv/bin/activate
          make tests

      - name: Build Packages
        run: |
          . ./venv/bin/activate
          make packages
          WHEEL=$(basename dist/*.whl)
          PKGVER=$(python3 ./setup.py --version)
          echo "WHEEL=$WHEEL" >> $GITHUB_ENV
          echo "PKGVER=$PKGVER" >> $GITHUB_ENV

      - name: Setup LXD
        run: |
          sudo ./scripts/setup-lxd.sh
          # Runner user can't acquire lxd group without exiting.
          sudo chown root.runner /var/snap/lxd/common/lxd/unix.socket

      - name: Build LXD Alpine image
        run: ./scripts/build-alpine-image.sh

      - name: Export LXD Image
        run: |
          lxc stop lxdrunner-build
          lxc publish lxdrunner-build --alias lxdrunner
          lxc image export lxdrunner dist/lxdrunner-alpine.img

      - uses: "marvinpinto/action-automatic-releases@latest"
        if: ${{ github.event.release.tag_name }}
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          files: |
            dist/lxdrunner-alpine.img.tar.gz
            dist/${{ env.WHEEL }}

      - uses: "marvinpinto/action-automatic-releases@latest"
        if: contains( ${{ env.PKGVER }}, 'dev')
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: true
          title: "Development Build ${{ env.PKGVER }}"
          files: |
            dist/lxdrunner-alpine.img.tar.gz
            dist/${{ env.WHEEL }}

      - name: Setup upterm session
        uses: lhotari/action-upterm@v1
        if: ${{ ( github.event_name == 'workflow_dispatch' && github.event.inputs.remote_debug) || failure() }}
        timeout-minutes: 5
